services:
  vecinita-app:
    build:
      context: .
      dockerfile: Dockerfile
    image: vecinita-app:latest
    container_name: vecinita-app
    # Map host port to container port exposed by uvicorn
    ports:
      - "8000:8000"
    # Pass Supabase and app configuration via environment
    environment:
      # Supabase and app configuration (matches .env)
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
      DATABASE_URL: ${DATABASE_URL}

      # API keys
      GROQ_API_KEY: ${GROQ_API_KEY}
      OPEN_API_KEY: ${OPEN_API_KEY}

      # LangSmith tracing
      LANGSMITH_TRACING: ${LANGSMITH_TRACING}
      LANGSMITH_ENDPOINT: ${LANGSMITH_ENDPOINT}
      LANGSMITH_API_KEY: ${LANGSMITH_API_KEY}
      LANGSMITH_PROJECT: ${LANGSMITH_PROJECT}

      # Embeddings and local LLM fallback
      EMBEDDING_MODEL: ${EMBEDDING_MODEL}
      USE_LOCAL_EMBEDDINGS: ${USE_LOCAL_EMBEDDINGS}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL}
      OLLAMA_MODEL: ${OLLAMA_MODEL}

      # TensorFlow and Performance
      TF_ENABLE_ONEDNN_OPTS: "0"

      # App runtime
      PORT: "8000"
      PYTHONUNBUFFERED: "1"
    # Ensure the container restarts if it crashes or the host reboots
    restart: unless-stopped
    # If your app writes to a local directory (e.g., logs, cache), mount it
    # volumes:
    #   - ./.data:/app/.data
    #   - ./logs:/app/logs
    # Healthcheck helps detect early failures
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 5s
      retries: 5

# Optional: define a network (Docker creates a default bridge network)
# networks:
#   default:
#     name: vecinita-net
