# Local Development Full Stack
# Includes: PostgreSQL, PostgREST, pgAdmin, Embedding Service, Agent Service, Frontend, Scraper
# Usage: docker-compose up
# Production uses cloud Supabase and Render services (see .env.prod and docs/RENDER_DEPLOYMENT_THREE_SERVICES.md)

services:
  # Local PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: vecinita-postgres-local
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
      POSTGRES_INITDB_ARGS: "--locale=en_US.UTF-8 --encoding=UTF8"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data_local:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - vecinita-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgREST - REST API layer on top of PostgreSQL
  postgrest:
    image: postgrest/postgrest:v12.0.1
    container_name: vecinita-postgrest-local
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGRST_DB_URI: postgresql://postgres:postgres@vecinita-postgres-local:5432/postgres
      PGRST_DB_SCHEMA: public
      PGRST_DB_ANON_ROLE: postgres
      PGRST_JWT_SECRET: dev-jwt-secret-for-local-testing-only-32chars-min
      PGRST_JWT_AUD: ""  # Allow any audience for development
      PGRST_JWT_ROLE_CLAIM_KEY: ".role"
    ports:
      - "3001:3000"  # PostgREST REST API on localhost:3001
    restart: unless-stopped
    networks:
      - vecinita-network
    healthcheck:
      # Use a simple binary check to avoid missing curl/wget in the image
      test: ["CMD", "postgrest", "--version"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin - PostgreSQL Management UI (Optional but useful)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: vecinita-pgadmin-local
    depends_on:
      - postgres
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "5050:80"
    restart: unless-stopped
    networks:
      - vecinita-network

  # ============================================================================
  # MICROSERVICES (Agent, Embedding, Scraper)
  # ============================================================================

  # Embedding Service - Lightweight microservice for text embeddings
  embedding-service:
    build:
      context: ./backend
      dockerfile: Dockerfile.embedding
    container_name: vecinita-embedding
    ports:
      - "8001:8001"
    environment:
      PORT: "8001"
      PYTHONUNBUFFERED: "1"
      HF_HOME: "/tmp/huggingface_cache"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - vecinita-network

  # Agent Service - FastAPI Q&A backend
  vecinita-agent:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: vecinita-agent
    ports:
      - "8000:8000"
    environment:
      PORT: "8000"
      PYTHONUNBUFFERED: "1"
      EMBEDDING_SERVICE_URL: "${EMBEDDING_SERVICE_URL:-http://embedding-service:8001}"
      SUPABASE_URL: "http://postgrest:3000"
      SUPABASE_KEY: "dev-anon-key"
      GROQ_API_KEY: "${GROQ_API_KEY}"
      DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/postgres"
    depends_on:
      postgres:
        condition: service_healthy
      postgrest:
        condition: service_healthy
      embedding-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - vecinita-network

  # Frontend - Vite React application
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: vecinita-frontend
    ports:
      - "5173:80"
    environment:
      # Empty VITE_BACKEND_URL enables relative paths (/config, /ask-stream)
      # Nginx proxies these requests to the backend via Docker network
      # Fixes "Failed to fetch" errors in Codespaces preview URLs
      VITE_BACKEND_URL: ""
    depends_on:
      - vecinita-agent
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - vecinita-network

volumes:
  postgres_data_local:

networks:
  vecinita-network:
    driver: bridge
